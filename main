import discord
from discord.ext import commands
import logging
from dotenv import load_dotenv
import os

load_dotenv()
token = os.getenv('DISCORD_TOKEN')

handler = logging.FileHandler(filename='discord.log', encoding='utf-8', mode='w')
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix='!', intents=intents)

@bot.event
async def on_ready():
    print(f"Bott is ready to go!")


count = 0

Counting_Channel = 1419648856395616266
countingChannelName = "bot-counting-channel"

counts = {}
sorted_counts = sorted(counts.items(), key= lambda x: x[1], reverse=True)
highest_scorers = {}

@bot.event
async def on_message(message):
    #Allow other messages/commands to be read
    await bot.process_commands(message)

    #my_guild = bot.get_guild(1417635099113033810)
    #Grab the guild (server) where the message was sent
    my_guild = message.guild

    #Grab the channel where the message was sent (if the channel isn't called
    #the variable named in countingChannelName then stop)
    counting_channel = discord.utils.get(my_guild.text_channels, name=countingChannelName)
    
    #If the channel doesn't exist or isn't the counting channel, return nothing
    if counting_channel is None or message.channel.id != counting_channel.id:
        return
    
    #Make sure the message is sent by the bot
    if message.author == bot.user:
        return
    
    bott_pings = discord.utils.get(my_guild.roles, name="Bot Pings")
    amateur_counter = discord.utils.get(my_guild.roles, name="Amateur Counter")
    intermediate_counter = discord.utils.get(my_guild.roles, name="Intermediate Counter")
    advanced_counter = discord.utils.get(my_guild.roles, name="Advanced Counter")
    pro_counter = discord.utils.get(my_guild.roles, name="Pro Counter")
    master_counter = discord.utils.get(my_guild.roles, name="Master Counter")
    global count
    global highest_scorer
    
    #Useful variables to have for shorthand
    user_id = message.author.id
    user_name = message.author.name
    
    #Only numeric messages count
    mesg = message.content.strip()
    try:
        value = int(mesg)
    except ValueError:
        return
    
    #Establish a dict for score if not existing yet
    guild_counts = counts.setdefault(my_guild.id, {})
    guild_counts.setdefault(user_id, 0)
    
    #Mess up counter
    if value != guild_counts[user_id] + 1:
        guild_counts[user_id] = 0
        await message.channel.send(f"{user_name}, **you messed up your count!** Your score is now back to 0.")

    #Otherwise implement the count
    else:
        guild_counts[user_id] = guild_counts[user_id] + 1
        user_score = guild_counts[user_id]
        #Autocommand for achievement checking
        if user_score >= 10 and user_score < 50 and amateur_counter not in message.author.roles:
            await message.author.add_roles(amateur_counter)
            await message.channel.send(f"{user_name} just earned an achievement - **Amateur Typer** Check your roles!")
        elif user_score >= 50 and user_score < 100 and intermediate_counter not in message.author.roles:
            await message.author.remove_roles(amateur_counter)
            await message.author.add_roles(intermediate_counter)
            await message.channel.send(f"{user_name} just earned an achievement - **Intermediate Typer** Check your roles!")
        elif user_score >= 100 and user_score < 250 and advanced_counter not in message.author.roles:
            await message.author.remove_roles(intermediate_counter)
            await message.author.add_roles(advanced_counter)
            await message.channel.send(f"{user_name} just earned an achievement - **Advanced Counter** Check your roles!")
        elif user_score >= 250 and user_score < 1000 and pro_counter not in message.author.roles:
            await message.author.remove_roles(advanced_counter)
            await message.author.add_roles(pro_counter)
            await message.channel.send(f"{user_name} just earned an achievement - **Pro Counter** Check your roles!")
        elif user_score >= 3010 and master_counter not in message.author.roles:
            await message.author.remove_roles(pro_counter)
            await message.author.add_roles(master_counter)
            await message.channel.send(f"{user_name} just earned an achievement - **Master Counter** Check your roles!")

    #Autocommand for when there is a new top scorer
    server_counts = counts.get(my_guild.id, {})
    if server_counts:
        sorted_counts = sorted(server_counts.items(), key= lambda x: x[1], reverse=True)
        highest_scorer_id, highest_score = sorted_counts[0]

        current_highest_scorer = highest_scorers.get(my_guild.id)
        new_highest_scorer = my_guild.get_member(highest_scorer_id)
        
        if new_highest_scorer and (current_highest_scorer is None or new_highest_scorer.id != current_highest_scorer.id:
            if current_highest_scorer:
                if bott_pings in current_highest_scorer.roles:
                    await message.channel.send(f"{new_highest_scorer} just beat {current_highest_scorer.mention}'s score to become our **new highest scorer!**")
                else:
                    await message.channel.send(f"{new_highest_scorer} just beat {current_highest_scorer}'s score to become our **new highest scorer!**")
            else:
                await message.channel.send(f"{new_highest_scorer} just became our **new highest scorer!**")
            highest_scorers[my_guild.id] = new_highest_scorer
    
@bot.command()
async def score(ctx, member: discord.Member = None):
    """Grab your score, or put in a friend's username to get *their* score!"""
    target_user = member or ctx.author
    guild_counts = counts.get(ctx.guild.id, {})
    user_score = guild_counts.get(target_user.id, 0)
    await ctx.send(f"**{target_user}** has a score of: {user_score}")

@bot.command()
async def leaderboard(ctx):
    """Show the top 3 scorers."""
    guild_counts = counts.get(ctx.guild.id, {})
    sorted_counter = sorted(guild_counts.items(), key= lambda x: x[1], reverse=True)

    if not sorted_counter:
        await ctx.send("No scores from this server yet. Get counting!")
        return

    for i in range(len(sorted_counter)):
        if i > 2:
            break
        name = ctx.guild.get_member(sorted_counter[i][0])
        if name:
            name = name.display_name
        score = sorted_counter[i][1]
        if i == 0:
            await ctx.send(f":first_place:: **{name}** - {score} points!")
        elif i == 1:
            await ctx.send(f":second_place:: **{name}** - {score} points!")
        elif i == 2:
            await ctx.send(f":third_place:: **{name}** - {score} points!")

#Command - Secret to give plus two points
@bot.command()
async def secret(ctx):
    """Top secret..."""
    guild_counts = counts.get(ctx.guild.id, {})
    guild_counts.setdefault(ctx.author.id, 0)
    guild_counts[ctx.author.id] += 2
    await ctx.send(f"{ctx.author.name} just got an extra two points! Don't tell anyone though...")

#Command - Help to explain the commands
@bot.command()
async def helpme(ctx):
    """See my explanation of the commands in proper Discord formatting"""
    commands = {}
    THE_message = ""
    for cmd in ctx.bot.commands:
        if cmd.help:
            commands[cmd.name] = cmd.help
        else:
            commands[cmd.name] = "No description provided, sorry!"
    THE_message += "Our current commands are: \n"
    for k,v in commands.items():
        THE_message += (f"\n{k} - {v}")
    await ctx.send(THE_message)

#Command - Rules to show how to play
@bot.command()
async def rules(ctx):
    """Explain the basic rules of the game"""
    await ctx.send("Here's how to play:\n1. Start counting up from zero to increase your score.\n2. Keep counting, but don't mess up or else your score is **back to zero!**\n3. Try to beat the scores of your friends! Use '!leaderboard' to see the current top scorers.\n4. Have fun!")

@bot.command()
async def pingrole(ctx):
    """Add the ping role to GET NOTIFIED when the top score is beaten"""
    role = discord.utils.get(ctx.guild.roles, name="Bot Pings")
    await ctx.author.add_roles(role)
    await ctx.send(f"{ctx.author}, you will **now be pinged** for Counter Bott notifications!")

@bot.command()
async def nopingrole(ctx):
    """Remove the Ping role to NOT GET NOTIFIED when the top score is beaten"""
    role = discord.utils.get(ctx.guild.roles, name="Bot Pings")
    await ctx.author.remove_roles(role)
    await ctx.send(f"{ctx.author}, you will **no longer be pinged** for Counter Bott notifications!")

# Make a GitHub repo (and upload to it without the bot token tho)

bot.run(token, log_handler=handler, log_level=logging.DEBUG)